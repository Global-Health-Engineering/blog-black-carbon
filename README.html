<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Saloni Vijay">
<meta name="dcterms.date" content="2024-07-16">
<meta name="description" content="Black carbon in the atmosphere contributes to climate change and is a known carcinogen. Yet, this pollutant remains largely unmonitored and unregulated. Despite its dangers, there are no guidelines on safe levels of black carbon in the air we breathe. It’s time to focus on establishing effective regulations to monitor and control black carbon concentrations in the atmosphere.">

<title>From Smoke to Solution: Advancing Black Carbon as a Regulatory Pollutant</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="README_files/libs/clipboard/clipboard.min.js"></script>
<script src="README_files/libs/quarto-html/quarto.js"></script>
<script src="README_files/libs/quarto-html/popper.min.js"></script>
<script src="README_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="README_files/libs/quarto-html/anchor.min.js"></script>
<link href="README_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="README_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="README_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="README_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="README_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


<meta name="citation_title" content="From Smoke to Solution: Advancing Black Carbon as a Regulatory Pollutant">
<meta name="citation_author" content="Saloni Vijay">
<meta name="citation_publication_date" content="2024-07-16">
<meta name="citation_cover_date" content="2024-07-16">
<meta name="citation_year" content="2024">
<meta name="citation_online_date" content="2024-07-16">
<meta name="citation_fulltext_html_url" content="https://ghe.ethz.ch/ghe-blog-news.html">
<meta name="citation_doi" content="TODO">
<meta name="citation_language" content="en">
<meta name="citation_journal_title" content="From Smoke to Solution: Advancing Black Carbon as a Regulatory Pollutant">
</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">From Smoke to Solution: Advancing Black Carbon as a Regulatory Pollutant</h1>
  <div class="quarto-categories">
    <div class="quarto-category">qualitative data</div>
    <div class="quarto-category">transparency</div>
    <div class="quarto-category">transcripts</div>
  </div>
  </div>

<div>
  <div class="description">
    <p>Black carbon in the atmosphere contributes to climate change and is a known carcinogen. Yet, this pollutant remains largely unmonitored and unregulated. Despite its dangers, there are no guidelines on safe levels of black carbon in the air we breathe. It’s time to focus on establishing effective regulations to monitor and control black carbon concentrations in the atmosphere.</p>
  </div>
</div>

<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://www.linkedin.com/in/saloni-vijay-9b9a51a7/">Saloni Vijay</a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://ghe.ethz.ch">
            Global Health Engineering, ETH Zurich
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 16, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="what-is-black-carbon" class="level2">
<h2 class="anchored" data-anchor-id="what-is-black-carbon">What is Black Carbon?</h2>
<p>Black carbon is an air pollutant: a component of fine particulate matter that is smaller than 2.5 mm in diameter (PM<sub>2.5</sub>), it is formed through the incomplete combustion of <a href="https://www.ccacoalition.org/short-lived-climate-pollutants/black-carbon">fossil fuels, biomass, and waste</a>. Essentially, it is a very small particle that forms part of a smoke plume that is either inhaled or dispersed into the atmosphere.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/thijs-stoop-A_AQxGz9z5I-unsplash.jpg" class="img-fluid figure-img" width="960"></p>
<figcaption>Black carbon, a sooty particulate matter in emission plumes. Photo by <a href="https://unsplash.com/photos/white-smoke-A_AQxGz9z5I">Thijs Stoop</a> on <a href="https://unsplash.com/">Unsplash</a>.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="the-case-for-regulation" class="level2">
<h2 class="anchored" data-anchor-id="the-case-for-regulation">The Case for Regulation</h2>
<p>Due to its significant climate and health impacts, as well as its traceability to specific sources, black carbon is increasingly discussed as a potential regulatory pollutant.</p>
<p><strong>Climate Impacts:</strong> Black carbon emissions are of concern due to their extremely high global warming potential: <a href="https://en.wikipedia.org/wiki/Open_burning_of_waste">up to 5000 times greater than CO<sub>2</sub></a>. Black carbon absorbs sunlight and heats the atmosphere, accelerating global warming. When deposited on ice and snow, it reduces their reflectivity, <a href="https://www.ccacoalition.org/short-lived-climate-pollutants/black-carbon">leading to quicker melting</a>.</p>
<p><strong>Health Impacts:</strong> These minute particles penetrate deep into the lungs and enter the bloodstream, exacerbating respiratory and cardiovascular diseases and increasing the risk of lung cancer. A specific form of PM<sub>2.5</sub>, it is <a href="https://iris.who.int/bitstream/handle/10665/352615/9789289002653-eng.pdf?sequence=1">more toxic to human health</a> than other types of PM<sub>2.5</sub> such as dust.</p>
<p><strong>Source Identification:</strong> One reason why black carbon would be easier to regulate than other pollutants is our ability to <a href="https://iris.who.int/bitstream/handle/10665/352615/9789289002653-eng.pdf?sequence=1">pinpoint the source.</a> Black carbon from fossil fuels and biomass can be distinguished by their optical properties, allowing for targeted reduction strategies. This capability enhances the effectiveness of emission reduction efforts, enabling evidence-based decisions to address the predominant sources.</p>
<section id="gaps-in-global-monitoring-the-case-of-africa" class="level3">
<h3 class="anchored" data-anchor-id="gaps-in-global-monitoring-the-case-of-africa"><strong>Gaps in Global Monitoring: The case of Africa</strong></h3>
<p>Despite the significant climate and health impacts of black carbon, global monitoring efforts remain inadequate. While ambient black carbon monitoring is <a href="https://www.clarity.io/blog/air-quality-measurements-series-black-carbon">increasing in European countries</a>, the United States, <a href="https://mausam.imd.gov.in/imd_latest/contents/environmental-monitoring-services.php">India</a> and <a href="https://www.mdpi.com/2073-4433/11/7/684">China</a>, but Africa lags behind. Only a few countries, such as <a href="https://www.sciencedirect.com/science/article/pii/S0048969723011981">Ghana</a>, <a href="https://www.nature.com/articles/s43247-022-00400-1">Kenya</a>, and <a href="https://www.sciencedirect.com/science/article/abs/pii/S2212095522002309#:~:text=Only%20two%20studies%20of%20BC,et%20al.%2C%202020">Rwanda</a>.), have some ambient black carbon data, with the high cost of monitors being a major barrier to more extensive data collection.</p>
<p>Even PM<sub>2.5</sub>, which was declared a regulatory pollutant in 1997 in the U.S., is still inadequately monitored in many African countries. Western Africa has approximately one reference-grade<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> PM<sub>2.5</sub> monitor per 10 million people, and the situation is even worse in Eastern Africa, with only <a href="https://scielo.org.za/scielo.php?script=sci_arttext&amp;pid=S2410-972X2021000100009#:~:text=In%20Western%20Africa%2C%20there%20is,et%20al.%2C%202020">one reference-grade monitor per 100 million people</a>.). Introducing black carbon as a regulatory pollutant would require substantial investment and infrastructure development to achieve effective monitoring across the continent. <a href="#fig-openaq" class="quarto-xref">Figure&nbsp;1</a> illustrates the global distribution of PM2.5 monitoring stations, as documeted by OpenAQ<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-openaq" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-openaq-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/screenshot-openaq.png" class="img-fluid figure-img" width="469">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-openaq-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: A screenshot from OpenAQ illustrating the global distribution of PM2.5 monitoring stations.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="overcoming-cost-barriers-innovating-affordable-solutions" class="level2">
<h2 class="anchored" data-anchor-id="overcoming-cost-barriers-innovating-affordable-solutions">Overcoming Cost Barriers: Innovating Affordable Solutions</h2>
<p>Low-cost PM<sub>2.5</sub> monitors have expanded access to air quality data. We need similar advancements for black carbon monitoring. Developing hybrid networks that integrate low-cost monitors with reference-grade stations could enhance coverage and accuracy. Currently, what is considered cost-effective <a href="https://metone.com/introducing-the-groundbreaking-c-12-portable-carbon-monitor-making-carbon-measurements-accessible-worldwide/">often exceeds 3000 USD</a>. During my PhD research in <a href="https://en.wikipedia.org/wiki/Malawi">Malawi</a>, I utilized the <a href="https://aethlabs.com/microaeth/ma200/overview">microAeth<sup>®</sup> MA200</a> monitor for personal exposure measurements, which, while less costly than other monitors, was still expensive for the low-income context. Each filter tape, costing approximately 100 USD, lasted only three days due to the high-concentration environment, underscoring the ongoing financial challenges in resource-limited settings.</p>
<p>Research efforts are crucial to developing affordable monitoring technology, particularly in regions like <a href="https://www.clarity.io/blog/air-quality-measurements-series-black-carbon#:~:text=More%20than%2075%25%20of%20global,lack%20comprehensive%20air%20quality%20regulations.">Asia and Africa that contribute 63% of global black carbon emissions</a>. Current monitors, primarily designed for cleaner environments, are inadequate for high-emission areas; even after the initial investment, recurring costs such as filter tapes continue to pose challenges.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/measuring-air-quality.jpg" class="img-fluid figure-img" width="198"></p>
<figcaption>Saloni Vijay, the author of this blog (right), and Hope Kelvin Chilunga (left), a collaborator of the GHE group, setting up an experiment to monitor black carbon emissions from cooking with solid biofuels in Blantyre, Malawi. Photo by Saloni Vijay, <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC-BY</a> license.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="navigating-ambient-concentrations-the-need-for-standards" class="level2">
<h2 class="anchored" data-anchor-id="navigating-ambient-concentrations-the-need-for-standards">Navigating Ambient Concentrations: The Need for Standards</h2>
<p>In <a href="https://visitmalawi.mw/index.php/blantyre-city/">Blantyre, Malawi</a>, the average black carbon concentration was 3.85 μg/m<sup>3</sup> in July-August 2023. Without established regulatory standards, interpreting such figures remains challenging. While black carbon monitoring has seen recent advancements, questions persist: Are these concentrations safe?</p>
<p>While no national or international air quality standards for black carbon exist yet, both the <a href="https://fpi.ec.europa.eu/news/eu-action-sheds-light-black-carbon-emissions-2019-08-27_en">European Union</a> and the <a href="https://iris.who.int/bitstream/handle/10665/352615/9789289002653-eng.pdf?sequence=1">World Health Organization</a> have recognized its significant threats to health and climate. This acknowledgment suggests <a href="https://en.ilmatieteenlaitos.fi/tiedote/5ePGJSjeZo1t5qvIjQO992">impending regulations on black carbon emissions and air quality standards.</a></p>
<div>

</div>
<div class="quarto-layout-panel" data-layout="[9,-1,16]">
<div class="quarto-layout-row quarto-layout-valign-bottom">
<div class="quarto-layout-cell" style="flex-basis: 34.6%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/personal-monitor.jpg" class="img-fluid figure-img"></p>
<figcaption>A volunteer wears a personal monitor for Saloni’s PhD project on black carbon exposure. Photo by Saloni Vijay, <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC-BY</a> license.</figcaption>
</figure>
</div>
</div>
<div class="quarto-figure-spacer quarto-layout-cell" style="flex-basis: 3.9%;justify-content: flex-start;">
<p>&nbsp;</p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 61.5%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/plot-measurements.png" class="img-fluid figure-img"></p>
<figcaption>Personal exposure to black carbon in Blantyre, Malawi, during the burning of garden waste. The red oval indicates the burning period. Because there are no regulatory limits on ambient air concentrations, the risks are unclear.</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="steps-forward" class="level2">
<h2 class="anchored" data-anchor-id="steps-forward">Steps Forward</h2>
<p>Effective black carbon regulation requires a multifaceted approach that includes technological, regulatory, and educational initiatives.</p>
<p><strong>Develop Affordable Monitors:</strong>&nbsp;To make black carbon regulation feasible, affordable and reliable monitoring technology must be developed. Investment in research and the development of low-cost monitors is essential to facilitate widespread adoption.</p>
<p><strong>Establish Clear Guidelines</strong> <strong>for Monitoring and Reporting:</strong> These guidelines should be internationally harmonized to ensure consistency and comparability of data. Additionally, proper limits for ambient concentrations need to be established to provide clear standards for assessing black carbon levels and their impacts.</p>
<p><strong>Raise Awareness and Build Capacity</strong>:&nbsp;This includes training and resources for local authorities to implement and maintain monitoring networks.</p>
<p><strong>Policy Integration:</strong>&nbsp; Leveraging existing infrastructure and expertise from PM<sub>2.5</sub> monitoring could accelerate the implementation of black carbon regulations.</p>
<p>By addressing these key areas, we can enhance our ability to monitor, regulate, and reduce black carbon concentrations, ultimately improving air quality and public health.</p>
</section>
<section id="about-the-author" class="level2">
<h2 class="anchored" data-anchor-id="about-the-author">About the author</h2>
<p><a href="https://www.linkedin.com/in/saloni-vijay-9b9a51a7/">Saloni Vijay</a> is a PhD student in the Global Health Engineering group, ETH Zurich. She is currently focused on evaluating the environmental risks and health impacts of open trash burning, with a specific emphasis on black carbon concentrations in Blantyre, Malawi.</p>
<p>If you are interested in learning more about Saloni’s work on Black Carbon in Blantyre, feel free to write her an email at <a href="mailto:svijay@ethz.ch">svijay@ethz.ch</a> or on <a href="https://www.linkedin.com/in/saloni-vijay-9b9a51a7/">LinkedIn</a>.</p>
<p>Saloni is giving a talk at the <a href="https://www.eac2024.fi/">European Aerosol Conference, 2024 in August in Tampere, Finland</a>, and attending the <a href="https://icacgp-igac2024.com/">International Global Atmospheric Chemistry (IGAC) short course and conference, 2024 in September in Malaysia</a>. If you are present at any of these events, please reach out and connect. She would love to hear about your work and share hers.</p>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>A reference-grade air quality monitor is a high-precision, certified instrument used for accurate and reliable measurements of air pollutants, meeting stringent regulatory standards.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>OpenAQ is a nonprofit organization providing universal access to air quality data to empower a global community of changemakers to solve air inequality—the unequal access to clean air.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@misc{vijay2024,
  author = {Vijay, Saloni},
  title = {From {Smoke} to {Solution:} {Advancing} {Black} {Carbon} as a
    {Regulatory} {Pollutant}},
  date = {2024-07-16},
  url = {https://ghe.ethz.ch/ghe-blog-news.html},
  doi = {TODO},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-vijay2024" class="csl-entry quarto-appendix-citeas" role="listitem">
Vijay, Saloni. 2024. <span>“From Smoke to Solution: Advancing Black
Carbon as a Regulatory Pollutant.”</span> <em>From Smoke to Solution:
Advancing Black Carbon as a Regulatory Pollutant</em>. <a href="https://doi.org/TODO">https://doi.org/TODO</a>.
</div></div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>